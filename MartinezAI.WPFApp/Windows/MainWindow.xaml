<Window x:Class="MartinezAI.WPFApp.Windows.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MartinezAI.WPFApp.Windows"
        xmlns:vm="clr-namespace:MartinezAI.WPFApp.ViewModels"
        xmlns:converters="clr-namespace:MartinezAI.WPFApp.Converters"
        xmlns:extensions="clr-namespace:MartinezAI.WPFApp.ExtensionMethods"
        xmlns:mdxam="clr-namespace:MdXaml;assembly=MdXaml"
        mc:Ignorable="d"
        Title="{Binding AppTitle}" 
        d:DesignHeight="900" 
        d:DesignWidth="800" 
        WindowState="Maximized"
        Foreground="{DynamicResource MainFontForegroundBrush}"
        Background="{DynamicResource AppBackgroundBrush}"
        Style="{DynamicResource WindowSettings}">

    <Window.DataContext>
        <vm:MainWindowViewModelDesign />
    </Window.DataContext>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/MainWindowStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" MinWidth="300" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        
        <GridSplitter Grid.Column="1" 
                      Width="5" 
                      HorizontalAlignment="Left"
                      Background="{DynamicResource ContainerBorderBrush}" />
        
        <!-- CHAT LIST -->
        <Border Grid.Column="0" 
                Margin="10" 
                d:Width="300"
                BorderThickness="1" 
                BorderBrush="{DynamicResource ContainerBorderBrush}"
                HorizontalAlignment="Stretch">

            <Grid Margin="5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                
                <!-- CHATS LABEL -->
                <TextBlock Grid.Row="0" Text="CHATS" FontSize="22" FontWeight="Bold" HorizontalAlignment="Center" />
                
                <!-- CHAT LIST SCROLLVIEWER -->
                <ListBox Grid.Row="1"
                         Margin="0,10,0,0"
                         ItemsSource="{Binding ChatHistory}"
                         Background="{DynamicResource AppBackgroundBrush}"
                         BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ItemContainerStyle="{StaticResource ChatHistoryListBoxItemContainerStyle}" 
                         SelectedItem="{Binding SelectedChat}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <TextBlock Grid.Column="0"
                                           Text="{Binding ChatTitle}"
                                           TextTrimming="CharacterEllipsis"
                                           Foreground="{DynamicResource MainFontForegroundBrush}"
                                           VerticalAlignment="Center"/>

                                <Border Grid.Column="1"
                                        Background="Red"
                                        Width="15">
                                    <TextBlock Text="X"
                                               FontWeight="Bold"
                                               FontSize="12"
                                               Width="10"
                                               TextAlignment="Center"
                                               VerticalAlignment="Center">
                                    </TextBlock>
                                    <Border.InputBindings>
                                        <MouseBinding Command="{Binding DataContext.CloseChatCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                      CommandParameter="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"
                                                      MouseAction="LeftClick" />
                                    </Border.InputBindings>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>


                <!-- CREATE NEW CHAT -->
                <Button Grid.Row="2" Margin="0,10,0,0" Content="START NEW CHAT" Command="{Binding StartChatCommand}" />
            </Grid>
            
        </Border>

        <!-- ACTUAL CHAT -->
        <Grid Grid.Column="2" Visibility="{Binding IsChatSelected, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            
            <!-- CHAT HEADER -->
            <Border Grid.Row="0"
                    Margin="10"
                    Padding="10"
                    BorderBrush="{DynamicResource ContainerBorderBrush}"
                    BorderThickness="1">
                <StackPanel>
                    <TextBlock Text="Title:" />
                    <TextBlock Text="{Binding SelectedChat.ChatTitle}"
                               FontStyle="Italic"
                               FontSize="14"
                               Margin="0,0,0,0" 
                               Foreground="#FFD2A320" />

                    <TextBlock Text="AI Context:"
                               Margin="0,10,0,0"/>
                    <ScrollViewer MaxHeight="150"
                                  Margin="0,5,0,0"
                                  VerticalScrollBarVisibility="Auto">
                        <TextBlock Text="{Binding SelectedChat.ChatContext}"
                               FontStyle="Italic"
                               FontSize="14"
                               Foreground="#FFD2A320"
                               TextWrapping="Wrap"/>
                    </ScrollViewer>
                </StackPanel>
            </Border>
            
            <!-- CHAT HISTORY -->
            <Grid Grid.Row="1"
                  Margin="10">

                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="HISTORY"
                           FontWeight="Bold"
                           FontSize="22"/>

                <ScrollViewer Grid.Row="1"
                              x:Name="chatScrollViewer"
                              Margin="0,5,0,0"
                              extensions:ScrollViewerExtensions.AlwaysScrollToEnd="True">
                    <ItemsControl Background="#FFE8E8E8"
                                  FontFamily="Arial"
                                  ItemsSource="{Binding SelectedChat.ChatMessages}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="10">
                                    <TextBlock Text="{Binding Entity, StringFormat=[{0}]:}"
                                           Foreground="#FF2D59E0"
                                           FontWeight="Bold"
                                           FontSize="14"
                                           FontStyle="Italic"/>
                                    <Border BorderThickness="1"
                                        BorderBrush="{DynamicResource ContainerBorderBrush}"
                                        Background="#FFB5B5B5"
                                        CornerRadius="5"
                                        Padding="10"
                                        Margin="0,3,0,0">
                                        <mdxam:MarkdownScrollViewer Markdown="{Binding Message}"
                                                                    Foreground="Black"
                                                                    VerticalScrollBarVisibility="Hidden"/>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
            
            <!-- USER INTERFACE -->
            <Grid Grid.Row="2"
                  Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- USER INPUT -->
                <TextBox x:Name="txtUserInput" 
                             Grid.Row="0"
                             Height="75"
                             AcceptsTab="True" 
                             VerticalScrollBarVisibility="Auto"
                             Text="{Binding UserInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding SendMessageCommand}" />
                        <KeyBinding Gesture="Shift+Return" Command="{Binding NewLineCommand}" CommandParameter="{Binding ElementName=txtUserInput, Mode=OneWay}" />
                    </TextBox.InputBindings>
                </TextBox>
            </Grid>
        </Grid>
    </Grid>
</Window>
